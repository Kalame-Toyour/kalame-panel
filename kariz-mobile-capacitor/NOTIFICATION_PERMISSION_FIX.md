# Notification Permission Dialog Fix

## مشکل اصلی

دیالوگ نوتیفیکیشن در اندروید‌های جدید (13+) در حالت "در انتظار تصمیم کاربر" گیر می‌کرد و هیچ دکمه‌ای برای فعال‌سازی نوتیفیکیشن نمایش نمی‌داد.

## دلایل مشکل

1. **وضعیت اولیه اشتباه**: `permissionStatus` به `'unknown'` تنظیم شده بود، اما دکمه "دادن دسترسی" فقط برای `'default'` نمایش داده می‌شد.

2. **عدم تشخیص اندروید 13+**: کد قدیمی برای اندروید 13+ درست کار نمی‌کرد.

3. **منطق نمایش دکمه‌ها**: دکمه‌ها بر اساس وضعیت مجوز نمایش داده نمی‌شدند.

## راه‌حل‌های اعمال شده

### 1. بهبود NotificationPermissionDialog.tsx

- **تشخیص اندروید**: اضافه کردن تابع `checkAndroidVersion()` برای تشخیص نسخه اندروید
- **منطق نمایش دکمه‌ها**: بهبود منطق نمایش دکمه‌ها بر اساس نسخه اندروید و وضعیت مجوز
- **وضعیت‌های مختلف**: پشتیبانی از تمام وضعیت‌های مجوز (`unknown`, `default`, `denied`, `granted`)
- **دکمه‌های مناسب**: نمایش دکمه‌های مناسب برای هر وضعیت

### 2. بهبود App.tsx

- **منطق نمایش دیالوگ**: بهبود منطق تصمیم‌گیری برای نمایش دیالوگ
- **بررسی مجوز مرورگر**: بررسی وضعیت مجوز مرورگر قبل از نمایش دیالوگ
- **مدیریت بهتر اندروید 13+**: نمایش دیالوگ برای اندروید 13+ حتی اگر مجوز مرورگر `'unknown'` باشد

### 3. بهبود push.ts

- **بررسی مجوز مرورگر**: بررسی مجوز مرورگر قبل از درخواست مجوز Capacitor
- **مدیریت خطا بهتر**: مدیریت بهتر خطاها و وضعیت‌های مختلف
- **لاگ‌های بهتر**: اضافه کردن لاگ‌های مفصل برای دیباگ

## تغییرات کلیدی

### NotificationPermissionDialog.tsx

```typescript
// تشخیص اندروید
const [androidVersion, setAndroidVersion] = useState<number>(0)

// منطق نمایش دکمه درخواست مجوز
const shouldShowRequestButton = () => {
  // برای اندروید 13+، همیشه دکمه را نمایش بده اگر مجوز داده نشده
  if (androidVersion >= 13) {
    return permissionStatus !== 'granted'
  }
  
  // برای اندروید قدیمی، فقط برای وضعیت 'default' نمایش بده
  return permissionStatus === 'default'
}
```

### App.tsx

```typescript
// برای اندروید 13+، دیالوگ را نمایش بده
if (androidVersion >= 13) {
  console.log('[App] Android 13+ detected, showing permission dialog for POST_NOTIFICATIONS')
  
  // بررسی مجوز مرورگر
  if ('Notification' in window) {
    const browserPermission = Notification.permission
    
    // اگر مجوز مرورگر 'default' یا 'unknown' باشد، دیالوگ را نمایش بده
    if (browserPermission === 'default' || browserPermission === 'unknown') {
      return true
    }
  }
}
```

## نحوه کارکرد

1. **اندروید 13+**: دیالوگ نمایش داده می‌شود و دکمه "درخواست مجوز نوتیفیکیشن" نمایش داده می‌شود
2. **اندروید قدیمی**: دیالوگ نمایش داده نمی‌شود (مجوز خودکار)
3. **وضعیت‌های مختلف**:
   - `'unknown'`: دکمه درخواست مجوز نمایش داده می‌شود
   - `'default'`: دکمه درخواست مجوز نمایش داده می‌شود
   - `'denied'`: دکمه راهنمای تنظیمات اندروید نمایش داده می‌شود
   - `'granted'`: دکمه بستن نمایش داده می‌شود

## تست

برای تست، دیالوگ را باز کنید و اطلاعات دیباگ را بررسی کنید:

- وضعیت مجوز
- نسخه اندروید
- نمایش دکمه‌ها

## نتیجه

حالا دیالوگ نوتیفیکیشن در اندروید 13+ درست کار می‌کند و کاربران می‌توانند مجوز نوتیفیکیشن را بدهند.
